name: Master CI/CD Pipeline 

on:
  push:
    branches: [ master-ci ]
  pull_request:
    branches: [ master-ci ]

jobs:
  build-and-test:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Check Docker is working
      run: docker --version

    - name: Check Docker Compose is working
      run: docker compose --version

    - name: Build and start services with Docker Compose
      run: |
        docker compose up -d --build
        sleep 30  # Wait for services to start

    - name: Health check backend
      run: |
        # Wait for backend to be ready
        timeout 60 bash -c 'until curl -f http://localhost:8080/health; do sleep 2; done' || echo "Backend health check failed or timed out"

    - name: Health check frontend
      run: |
        # Wait for frontend to be ready
        timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep 2; done' || echo "Frontend not responding or timed out"

    - name: Run integration tests
      run: |
        docker-compose exec backend-app go test ./... -v || echo "Integration tests skipped or failed"