# Обработка видео с CSRT трекингом

## Описание

Новый алгоритм обработки видео использует комбинацию:
- **YOLO детекция** - запускается каждый 10-й кадр для точного обнаружения объектов
- **CSRT трекинг** - отслеживает объекты на остальных 9 кадрах

Это дает значительное ускорение обработки при сохранении качества детекции.

## Преимущества

✅ **Производительность**: В 5-10 раз быстрее по сравнению с YOLO на каждом кадре  
✅ **Качество**: CSRT трекер точно отслеживает объекты между детекциями  
✅ **Масштабируемость**: Поддержка множества объектов одновременно  
✅ **Гибкость**: Настраиваемый интервал детекции

## Использование в коде

```python
from app.ml.tools.object_detector import MLObjectDetector

# Инициализация
detector = MLObjectDetector(
    face_model_path="models/yolov11m-face.pt",
    general_model_path="models/yolo11m.pt",
    confidence_threshold=0.5
)
detector.initialize()

# Обработка с трекингом
output_path = detector.process_video_with_tracking(
    video_path="video.mp4",
    object_types=["face"],  # или ["person", "car", "face"] и т.д.
    intensity=25,
    blur_type="pixelate",  # gaussian, pixelate, blackout
    detection_interval=10   # YOLO каждый 10-й кадр
)
```

## Запуск демо

### Вариант 1: Из корня проекта
```bash
cd C:\Users\Lanutrix\obscura-project\backend\ml
python demo_tracking.py
```

### Вариант 2: Через Docker
```bash
# В контейнере ML сервиса
docker exec -it obscura-ml python demo_tracking.py
```

## Параметры

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `detection_interval` | Интервал кадров для YOLO | 10 |
| `object_types` | Типы объектов для детекции | ["face"] |
| `blur_type` | Тип размытия | "pixelate" |
| `intensity` | Интенсивность размытия | 25 |

## Поддерживаемые типы объектов

- **face** - лица людей (модель yolov11m-face.pt)
- **person** - люди целиком
- **car** - автомобили
- **truck** - грузовики
- **bus** - автобусы
- **bicycle** - велосипеды
- **motorcycle** - мотоциклы
- И другие объекты из COCO датасета

## Результаты тестирования

Демо-скрипт обрабатывает видео двумя способами:
1. **С трекингом** - YOLO каждый 10-й кадр + CSRT
2. **Без трекинга** - YOLO на каждом кадре

И выводит сравнительную статистику производительности.

## Технические детали

### CSRT Tracker
- **Discriminative Correlation Filter with Channel and Spatial Reliability**
- Точный и устойчивый к изменениям масштаба
- Хорошо работает с частичными перекрытиями

### Алгоритм работы
1. На кадре №1, 11, 21... запускается YOLO детекция
2. Для каждого найденного объекта создается новый CSRT трекер
3. На кадрах 2-10, 12-20... трекеры обновляют позиции объектов
4. Если трекер теряет объект, он удаляется из списка
5. На следующем кадре детекции процесс повторяется

### Оптимизация
- Трекеры автоматически удаляются при потере объекта
- Каждый трекер хранит класс и уверенность из последней детекции
- Минимальные накладные расходы на память

